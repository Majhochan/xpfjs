<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Tales Runner - Circular Dash Update</title>
    <style>
        body { margin: 0; overflow: hidden; background: #a3d2ff; font-family: 'Malgun Gothic', sans-serif; }
        
        /* [Lobby & UI] */
        #lobby { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; }
        #game-ui { position: absolute; width: 100%; height: 100%; display: none; pointer-events: none; }

        /* 원형 대쉬 게이지 */
        #dash-wrapper {
            position: absolute; left: 40px; bottom: 40px; width: 100px; height: 100px;
        }
        .circular-progress {
            width: 100px; height: 100px; border-radius: 50%;
            background: conic-gradient(#444 0deg, #444 360deg); /* 배경 */
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .circular-progress::before {
            content: ""; position: absolute; width: 75px; height: 75px;
            background: rgba(0,0,0,0.6); border-radius: 50%; /* 가운데 구멍 */
        }
        #dash-value {
            position: relative; color: white; font-weight: bold; font-size: 18px; z-index: 10;
        }

        /* 하단 진행도 */
        #progress-container { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 60%; height: 10px; background: rgba(0,0,0,0.5); border-radius: 5px; border: 2px solid white; }
        #progress-icon { position: absolute; top: -15px; width: 30px; height: 30px; background: #ff4444; border-radius: 50%; border: 2px solid white; left: 0%; margin-left: -15px; }

        #result-screen { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 200; color: white; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1>TALES RUNNER</h1>
        <input type="text" id="nick-input" placeholder="닉네임" maxlength="8" style="padding:10px; border-radius:20px; border:none; text-align:center;">
        <button onclick="tryStart()" style="margin-top:20px; padding:10px 40px; cursor:pointer; border-radius:20px; border:none; background:#ffcc00; font-weight:bold;">START</button>
    </div>

    <div id="game-ui">
        <div id="dash-wrapper">
            <div class="circular-progress" id="dash-circle">
                <div id="dash-value">15</div>
            </div>
            <div style="color:white; text-align:center; font-size:12px; margin-top:5px; text-shadow:1px 1px 2px #000;">DASH (Z)</div>
        </div>

        <div id="progress-container">
            <div id="progress-icon"></div>
        </div>
    </div>

    <div id="result-screen">
        <h2 id="res-nick"></h2>
        <button onclick="location.reload()">RESTART</button>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';

        let gameStarted = false, gameFinished = false;
        let totalDist = 1500, currentDist = 0;
        
        // --- 대쉬 시스템 설정 ---
        let dashMax = 15;
        let dashCurrent = 15;
        const dashDepleteRate = 15 / 13; // 13초 동안 15 소모
        const dashRecoverRate = 1;     // 초당 1 회복

        const scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0xa3d2ff, 20, 150);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 조명 및 배경
        const sun = new THREE.DirectionalLight(0xffffff, 1);
        sun.position.set(5, 20, 10);
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));

        const trackGeo = new THREE.PlaneGeometry(15, 200);
        const trackMat = new THREE.MeshPhongMaterial({ color: 0x5cace2 });
        const tracks = [new THREE.Mesh(trackGeo, trackMat), new THREE.Mesh(trackGeo, trackMat)];
        tracks[0].rotation.x = tracks[1].rotation.x = -Math.PI/2;
        tracks[1].position.z = -200;
        tracks.forEach(t => scene.add(t));

        const player = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.5, 0.8), new THREE.MeshPhongMaterial({ color: 0xffffff }));
        body.position.y = 0.75;
        player.add(body);
        scene.add(player);

        let keys = {}, speed = 0, lastTime = Date.now();

        window.tryStart = () => {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            gameStarted = true; lastTime = Date.now();
        };

        window.onkeydown = e => keys[e.code] = true;
        window.onkeyup = e => keys[e.code] = false;

        function updateDashUI() {
            const circle = document.getElementById('dash-circle');
            const valueTxt = document.getElementById('dash-value');
            const percentage = (dashCurrent / dashMax) * 100;
            const degrees = (dashCurrent / dashMax) * 360;

            // 색상 계산 (낮으면 빨강(0), 높으면 파랑(240))
            const hue = (dashCurrent / dashMax) * 200; // 0 to 200 (Red to Light Blue)
            const color = `hsl(${hue}, 80%, 50%)`;

            circle.style.background = `conic-gradient(${color} ${degrees}deg, #444 ${degrees}deg)`;
            valueTxt.innerText = Math.ceil(dashCurrent);
            valueTxt.style.color = color;
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!gameStarted || gameFinished) { renderer.render(scene, camera); return; }

            const now = Date.now();
            const deltaTime = (now - lastTime) / 1000;
            lastTime = now;

            // 1. 대쉬 로직 적용
            let isDashing = keys['KeyZ'] && dashCurrent > 0;
            if (isDashing) {
                dashCurrent = Math.max(0, dashCurrent - (dashDepleteRate * deltaTime));
            } else {
                dashCurrent = Math.min(dashMax, dashCurrent + (dashRecoverRate * deltaTime));
            }
            updateDashUI();

            // 2. 속도 및 이동
            let targetSpeed = isDashing ? 1.8 : 0.9;
            speed += (targetSpeed - speed) * 0.1;

            if(keys['ArrowLeft'] && player.position.x > -6) player.position.x -= 0.2;
            if(keys['ArrowRight'] && player.position.x < 6) player.position.x += 0.2;

            // 3. 카메라 틸트 및 시점 (이전 동일)
            camera.fov += ((isDashing ? 75 : 60) - camera.fov) * 0.1;
            camera.updateProjectionMatrix();
            camera.position.lerp(new THREE.Vector3(player.position.x * 0.4, player.position.y + 4, 10), 0.1);
            camera.lookAt(player.position.x, player.position.y + 1, player.position.z - 10);

            // 4. 진행도 업데이트
            currentDist += speed;
            document.getElementById('progress-icon').style.left = Math.min(100, (currentDist / totalDist) * 100) + "%";

            if(currentDist >= totalDist) {
                gameFinished = true;
                document.getElementById('result-screen').style.display = 'flex';
                document.getElementById('res-nick').innerText = (document.getElementById('nick-input').value || "런너") + "님 완주!";
            }

            tracks.forEach(t => { t.position.z += speed; if(t.position.z > 100) t.position.z -= 200; });
            renderer.render(scene, camera);
        }

        animate();
    </script>
</body>
</html>
